(function(){var a=[],b=function(b){var c,d=!1,e=[],f=[],g=[],h=5,i={last:undefined,first:undefined,packets:{}},j,k=function(a,b){i.packets[a]={id:b,next:undefined},i.packets[i.first].next=a,i.first=a},l=function(a){var b=i.last,c=i.packets[b],d=c.next;k(a,a),i.last=d,delete i.packets[b],delete c},m=function(a){return!i.packets[a]||i.packets[a].id!==a};(function(){var a;i.packets[0]={id:!1,next:undefined},i.first=0,i.last=0;for(a=1;a<=h;a++)k(a,!1)})();var n=function(a){var c=a.parent_type+':'+a.type;if(m(a.id)){l(a.id);var d=!0;b(g[c]).each(function(b,c){if(c(a)===!1)return d=!1,!1});if(!d)return!1;b(f[c]).each(function(c,d){var e=b.extend(!0,{},a);d(e)})}},o=function(a,b,c){var d=a+':'+b;if(f[d]){var e=_.find(f[d],function(a){return a==c});e||f[d].push(c)}else f[d]=new Array(c);return this},p=function(a,b,c){var d=a+':'+b;if(g[d]){var e=_.find(g[d],function(a){return a==c});e||g[d].push(c)}else g[d]=new Array(c);return this},q=function(a,b,c){c=c||window,b=b||[],d?a.apply(c,b):e.push({f:a,args:b,context:c})},r=function(){for(var a=0;a<e.length;a++){var b=e[a];b.f.apply(b.context,b.args)}e=[]},s=function(a,b){c.send(JSON.stringify({channel:a,body:b}))},t=function(){c&&c.close()},u=function(a){typeof a!='undefined'&&(typeof j=='undefined'||j.join('')!==a.join(''))&&(j=a,t())},v=function(){return b.ajax({url:'/ajax/pinky/header.php',dataType:'json',cache:!1,data:{}})},w=function(){return c&&c.readyState},x=function(a,b,c){this.name=a,this.first_fail=!0,this.first_timeout=c,this.wait_time=b,this.reset_time=b};x.prototype.fail=function(){var a;return this.first_fail?(this.first_fail=!1,a=this.first_timeout):(a=this.wait_time,this.wait_time*=2,this.wait_time=Math.min(this.wait_time,6e4)),console.log(this.name+' Failed retrying in '+a),a},x.prototype.ok=function(){if(!this.first_fail){console.log(this.name+' Recovered');var a,b='libnotify.connected',c,d='libnotify.connected.immediate';try{a=new Event(b),c=new Event(d)}catch(e){a=document.createEvent('Event'),c=document.createEvent('Event'),a.initEvent(b,!0,!1),c.initEvent(d,!0,!1)}setTimeout(function(){document.dispatchEvent(a)},Math.random()*3e4),document.dispatchEvent(c)}this.first_fail=!0,this.wait_time=this.reset_time};var y=function(b){var e,f=new x('sockJS Connect',1e3,200),g=new x('sockJS Reconnect',1e3,200),h=new x('sockJS Auth',4e3,500);v().then(function(e){var i=e.data.userJobs,j={hash:getCookie(flns.config.cookie_base+'_AUTH_HASH'),hash2:getCookie(flns.config.cookie_base+'_AUTH_HASH_V2'),user_id:getCookie(flns.config.cookie_base+'_USER_ID'),channels:i};if(j.hash2==''&&j.hash==''||j.user_id=='')return!1;var k=function(){c=new SockJS(flns.config.notify_server),j.channels=i,c.onmessage=function(e){var f=JSON.parse(e.data);a.length<100&&(f.body.parent_type==='onlineoffline'||f.channel==='subscribe')&&a.push(f),f.channel=='user'?n(f.body):f.channel=='subscribe'&&(g.ok(),f.body=='NO'?(b(),c.close(4e3,'Auth Failure')):(h.ok(),d=!0,r()))},c.onopen=function(){var a;c&&c._transport&&c._transport.url&&c._transport.url.split('/').length!==0&&(a=c._transport.url.split('/')[4]);var b=(new Date).getTime();window.sessionStorage&&(window.sessionStorage.setItem('notification_socket_session_id',a),window.sessionStorage.setItem('notification_socket_session_time',b)),f.ok(),c.send(JSON.stringify({channel:'auth',body:j}))},c.onclose=function(a){c=undefined,d=!1,a.code===4e3?setTimeout(k,h.fail()):a.wasClean?setTimeout(k,g.fail()):setTimeout(k,f.fail())}};k()})},z=function(){return a};return y(function(){console.log('auth failure')}),{log:!0,register:o,register_filter:p,close:t,packets:i,send:s,ready:q,set_job_channel:u,getSocketReadyState:w,getEventHistory:z}};typeof define=='function'&&define.amd?define(['jquery-wrapper','notification/sockjs'],function(a){return window.libnotify=window.libnotify||b(a)}):window.libnotify=b(jQuery)})()