define(['jquery-wrapper','membership/api'],function(a,b){(function(){function l(b){a('#verify-payment-section').removeClass('is-collapsed'),a('html,body').animate({scrollTop:a('#verify-payment-section').offset().top-60},'slow'),b.preventDefault()}function m(b,c,d){a('#ccAdd').hide(),a('#ccLoader').show();var e=document.getElementById('ccAdd-v2');e&&e.getAttribute('data-spinner-target')&&(e=document.getElementById(e.getAttribute('data-spinner-target'))),e&&e.classList.add('processing');var f='/ajax/payment/flnBilling.php',g=getQueryStringValueByName('disable_adaptive')==='true',h=getQueryStringValueByName('enable_external')==='true';a.ajax({type:'POST',url:f,dataType:'json',data:{thm_session:a('#thm_session').attr('value'),action:'setupRecurring',backUrl:b,successUrl:c,back:document.URL,cc_gateway:d,disable_adaptive:g,enable_external:h,skip_bad_bins_origin:skip_bad_bins_origin},success:function(b){b.rs==='failure'?(a('#ccAdd').show(),a('#ccLoader').hide(),e&&e.classList.remove('processing'),r('ccFailed'),p(T_('An error occurred.'),T_('<%= msg %>',{msg:b.msg}))):(a('#fr').hide(),a('#wpPaymentFrame').attr('src',b.url),a('#wpPaymentFrame').load(function(){r('ccContinue'),a('#verifyContainer').hide(),a('#gcPayment').fadeIn(),a('#wpPaymentFrame').show(),e&&e.classList.remove('processing'),a('#payment-methods-inner').addClass('is-collapsed'),a('#verify-payment-iframe-section').removeClass('is-hidden'),typeof plusTrialUpsell!='undefined'&&plusTrialUpsell&&a('html,body').animate({scrollTop:0},'slow')}))}})}function n(a){var b=window.frames.redirectFrame.document,c=b.getElementById('insertPlace'),d=b.createElement('form');d.setAttribute('type','hidden'),d.setAttribute('name','depositForm'),d.setAttribute('id','depositForm'),d.setAttribute('action','https://www.moneybookers.com/app/payment.pl'),d.setAttribute('method','POST');var e=b.createElement('input');e.setAttribute('type','hidden'),e.setAttribute('name','pay_to_email'),e.setAttribute('value',a.config.mb_account),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','transaction_id'),e.setAttribute('value',a.payment_id),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','recipient_description'),e.setAttribute('value',a.SITE_NAME),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','status_url'),e.setAttribute('value',a.status_url),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','return_url'),e.setAttribute('value',a.return_url),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','cancel_url'),e.setAttribute('value',a.cancel_url),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','language'),e.setAttribute('value','EN'),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','merchant_fields'),e.setAttribute('value','CUST_NUM, CUST_INVOICE, VERIFY_ONLY'),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','CUST_NUM'),e.setAttribute('value',a.user.id),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','CUST_INVOICE'),e.setAttribute('value',a.invoice_id),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','VERIFY_ONLY'),e.setAttribute('value',1),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','ondemand_max_amount'),e.setAttribute('value',a.ondemand_max_amount),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','ondemand_max_currency'),e.setAttribute('value',a.ondemand_max_currency),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','ondemand_note'),e.setAttribute('value',a.ondemand_note),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','ondemand_status_url'),e.setAttribute('value',a.status_url),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','currency'),e.setAttribute('value',a.currency.code),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','amount'),e.setAttribute('value',a.amount_to_send),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','amount2'),e.setAttribute('value',a.amount),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','amount2_description'),e.setAttribute('value','Deposited amount'),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','amount3'),e.setAttribute('value',a.fee),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','amount3_description'),e.setAttribute('value','Deposit fee'),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','confirmation_note'),e.setAttribute('value','Thank you for your deposit on '+a.SITE_NAME+'!'),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','detail1_description'),e.setAttribute('value','Description:'),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','detail1_text'),e.setAttribute('value',a.payment_descr),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','detail2_description'),e.setAttribute('value','Deposit #'),d.appendChild(e),e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','detail2_text'),e.setAttribute('value',a.invoice.id),d.appendChild(e),a.names&&(a.names.firstname&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','firstname'),e.setAttribute('value',a.names.firstname),d.appendChild(e)),a.names.lastname&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','lastname'),e.setAttribute('value',a.names.lastname),d.appendChild(e))),a.address&&(a.address.city&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','city'),e.setAttribute('value',a.address.city),d.appendChild(e)),a.address.zip&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','postal_code'),e.setAttribute('value',a.address.zip),d.appendChild(e)),a.address.country_iso3&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','country'),e.setAttribute('value',a.address.country_iso3),d.appendChild(e)),a.address.state_code&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','state'),e.setAttribute('value',a.address.state_code),d.appendChild(e)),a.address.address1&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','address'),e.setAttribute('value',a.address.address1),d.appendChild(e)),a.address.address2&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','address2'),e.setAttribute('value',a.address.address2),d.appendChild(e)),a.address.phone&&(e=b.createElement('input'),e.setAttribute('type','hidden'),e.setAttribute('name','phone_number'),e.setAttribute('value',a.address.phone),d.appendChild(e))),c.appendChild(d)}function o(b){var d='/api/memberships/0.1/trials/',e='',f='',g=getQueryStringValueByName('trial'),h={second:0,minute:1,hour:2,day:3,week:4,month:5,year:6,decade:7,century:8,millenium:9};a.ajax({type:'get',data:{packages:[b]},headers:getAuthHeader(),url:d,success:function(a){if(a.status==='success'){var d=a.result;g&&(d=d.filter(function(a){return a.trial_package_id+'.'+h[a.trial_duration.type]+'.'+a.trial_duration.cycle===g})),c=d.length>0&&d[0].eligible,d.length===0?e=T_('We\'re sorry, but this Membership Trial is no longer offered. That\'s unfortunate!'):b==5?e=T_('We\'re sorry, but it looks like you are no longer eligible for our Plus Membership Trial. That\'s unfortunate!'):b==8?e=T_('We\'re sorry, but it looks like you are no longer eligible for our Professional Membership Trial. That\'s unfortunate!'):e=T_('We\'re sorry, but it looks like you are no longer eligible for this Membership Trial. That\'s unfortunate!'),f=T_(' But you can still take advantage of all our great membership benefits <a href=\'/membership/\'>here</a>'),c===!1&&p(T_('Oops...'),e+f)}}})}function p(a,b){jq('#alert-modal h3').html(a),jq('#alert-modal .modal-body p').html(b),jq('#alert-modal').modal()}function q(a,b,c,d,e,f){_ttref.push(['_trackEvent','Membership',a,b,c,null,e,f])}function r(b){var c=['_trackEvent',membershipTrackingEvent,kindOfUpsell+b],d=a('#is_free_trial'),e=null;d.length&&(e=d.is(':checked')?'T':'U',c.pop,c.push(e)),_lt.push(['user_action',{section:kindOfUpsell+b,sub_section:MembershipReferralTTRef,label:e}])}function s(){i=a('#successUrl').val(),a('.corporate-welcome-checkbox').is(':checked')?k='Trial-Y':k='Trial-N',q('Click-Add-CC',ttrefLabel,null,null,'cur-'+currentPlanCode),m(a('#backUrl').val(),i,window.ccMethod)}var c,d,e,f,g=5,h='',i='',j=null,k=null;a(document).ready(function(){i=a('#successUrl').val(),d=getQueryStringValueByName('TrialUpsell2'),e=getQueryStringValueByName('quickVerify'),f=getQueryStringValueByName('package');var m=getQueryStringValueByName('funnel');f||(f=g),d=='true'&&!nubeloPromotion&&o(f);if(m){freeTrialGroup?h='SignupTrialOffer':h='SignupPV';var t=getQueryStringValueByName('free_trial'),u,v='signupPV';t?u='viewBobw':plusTrialUpsell?u='PmverifyNoUpsell':u='TrialUpsellPmverify',paymentVerified?v+='Pos':v+='Non',_ttref.pushToTracking('Membership',u,v,userType,currentMembership,'current-memb-package','trialEligible',trialEligible)}else d?h='TrialLanding':freeTrialGroup?h='TrialOffer':corporateWelcome?(h='corporatePV',j='corp-'+corpPlanCode):h='DefaultPV';q('View-'+h,ttrefLabel,null,null,'cur-'+currentPlanCode,j),e=='true'&&(a('.upsell-banner.verify, .verify-payment-copy').remove(),c&&a('#successUrl').val(a('#defaultSuccessUrl').attr('value'))),a('#is_free_trial').change(function(){a(this).is(':checked')?(a('#successUrl').val(a('#freeTrialSuccessUrl').attr('value')),a('#gcTrialInfo').show()):(a('#successUrl').val(a('#defaultSuccessUrl').attr('value')),a('#gcTrialInfo').hide())}),a('#skip-button-pv').on('click',function(){q('Click-Skip-This-Step-PV',ttrefLabel,null,null,'cur-'+currentPlanCode)}),a('#skip-button-upsell').on('click',function(){q('Click-Skip-This-Step-Upsell',ttrefLabel,null,null,'cur-'+currentPlanCode)}),a('#ccSubmit').on('click',function(){var b=a('#gc_country_code').val(),c=a('#gc_card_type').val();setupRecurringGlobalCollect(b,c,a('#backUrl').val(),a('#successUrl').val())}),a('#ccAdd, #ccAdd-v2').on('click',function(){isReferralChildUser&&!isGroupon?p(T_('Your card will be authenticated'),T_('A very small charge will be made on your card. Once successfully authenticated, this amount will be added to your Freelancer.com balance.')):s()}),a('#alert-modal .btn-info').click(function(){isReferralChildUser&&s()}),a('#ccCancel').on('click',function(){a('#ccAdd').show(),a('#ccDetails').hide()}),a('#ppAdd, #ppAdd-v2').on('click',function(){var b=a('#is_free_trial').is(':checked');i=a('#successUrl').val(),a('.corporate-welcome-checkbox').is(':checked')?k='Trial-Y':k='Trial-N',q('Click-Add-Paypal',ttrefLabel,null,null,'cur-'+currentPlanCode),a('#ppButtons').hide(),a('#ppLoader').css('display','block');var c=document.getElementById('ppAdd-v2');c&&c.getAttribute('data-spinner-target')&&(c=document.getElementById(c.getAttribute('data-spinner-target'))),c&&c.classList.add('processing');var d=a('#paypalCancelUrl').val(),e='/ajax/payment/generate-paypal-billing-agreement-link.php?back='+i+'&currentUrl='+d;return a.ajax({url:e,dataType:'json',success:function(a){a.status=='success'?(r('pp'),window.location=a.msg):(a.msg?p(T_('Error'),a.msg):p(T_('Error'),T_('Sorry, the operation failed.')),jq('#ppLoader').hide(),jq('#ppButtons').show(),c&&c.classList.remove('processing'))}}),!1}),a('.more-info-icon').hover(function(){var b=a(this).position().left,c=a(this).position().top-10,d=a('#trial-pop-up');d.css('z-index',1),d.css('left',b+'px'),d.css('top',c+'px'),d.show()},function(){var b=a('#trial-pop-up');b.hide()}),a('body').on('click',function(b){a('a.verify-payment-more-info').length&&!a(b.target).hasClass('verify-payment-more-info')&&a('a.verify-payment-more-info').popover('hide')}),a('#skrillAdd, #skrillAdd-v2').on('click',function(){var b=a('#is_free_trial').is(':checked');a('#skrillButtons').hide(),a('#skrillLoader').show(),a('#skillAdd-v2').addClass('processing');var c='/ajax/payment/skrill.php',d=0,e='';q('Click-Add-Skrill',ttrefLabel,null,null,'cur-'+currentPlanCode);if(getQueryStringValueByName('TrialUpsell')=='true'||getQueryStringValueByName('TrialUpsell2')=='true'||b)d=1;return getQueryStringValueByName('ref')!==''?e='&ref='+getQueryStringValueByName('ref'):e='&ref=promotion_pmverify_freetrial',jq('#verifyContainer').hide(),jq('#upsell').hide(),jq('#fr').fadeIn(),a.ajax({url:c,dataType:'json',data:'freetrial='+d+'&action=prepare'+e+'&pkg='+membershipPackageForTrial+'&csrf_token='+getCSRFToken(),success:function(b){b.status==='success'?(r('skrill'),b.action=='redirect'?window.location=b.url:(window.frames.redirectFrame.document.getElementById('redirect_msg').innerHTML='You are being redirected to the payment site...',n(b),window.frames.redirectFrame.document.getElementById('depositForm').submit(),a('#verify-payment-iframe-section').removeClass('is-hidden'),a('#payment-methods-inner').addClass('is-collapsed'))):(b.msg?p(T_('Error'),b.msg):p(T_('Error'),T_('Sorry, the operation failed.')),jq('#skrillLoader').hide(),jq('#skrillButtons').show(),jq('#fr').hide(),jq('#verifyContainer').show(),jq('#upsell').show(),a('#skrillAdd-v2').removeClass('processing'))}}),!1}),a('#start_free_trial').on('click',function(){window.location='/payments/verify.php?TrialUpsell2=true&ref=promotion_header_freetrial'}),a('#alert-modal .close, #alert-modal .btn-info').click(function(a){d&&(window.location='/membership/')}),a('#claimTrial, #verifyPaymentMethod').click(function(){a('#moreBidsNote').hide(),a('#verifyPaymentNote').show(),a('#paymentMethods').show()}),a('#showFeatures').click(function(){a('#featuresModal').modal('show')});var w=a('th.plus-plan').index();a('th:gt('+w+'), tr > td:nth-child(n+'+(w+2)+'), .free-trial-bubble').hide(),a('.features-modal .action-header').html(''),a('#verifyPaymentNote a').popover({html:!0,content:function(){return a('#verifyPaymentNote .popover-content').html()},template:'<div class="popover"><div class="arrow"></div><div class="popover-inner"><div class="popover-content"></div></div></div>'}),a('#gc_selected_card_type').change(function(){var b=a('#gc_country_code').val(),c=a('#gc_selected_card_type').val();a('#gcLoader').show(),a('#gcPaymentFrame').hide(),setupRecurringGlobalCollect(b,c,a('#backUrl').val(),a('#successUrl').val())}),a('#lnk-trigger, #secondary-lnk-trigger').click(function(a){window.location.href='/jobs/myskills/';return}),a('#cta-trigger, #secondary-cta-trigger').click(function(c){var d=a(this),e=d.attr('id');if(nubeloPromotion&&hasPlan){d.attr('verified')?b.updateAutoRenew(d.data('package-id'),d.data('auto-renew'),function(){},function(a){window.location.href='/jobs/myskills/'},function(){}):l(c);return}var f='new-'+d.attr('data-package-id')+'.'+d.attr('data-duration-type')+'.'+d.attr('data-duration-cycle');q('Upgrade-click-'+h,ttrefLabel,null,null,f,'old-'+currentPlanCode),d.attr('verified')?(a('#cta-trigger, #secondary-cta-trigger').addClass('processing').attr('disabled',!0),b.packagesSubscribe(d.attr('data-package-id'),d.attr('data-duration-type'),d.attr('data-duration-cycle'),d.attr('data-quantity'),d.attr('data-auto-renew'),d.attr('data-coupon')||null,d.attr('data-is-trial'),d.attr('data-currency-id'),d.attr('data-trial-id'),function(){},function(a){if(a.status==='success'){var b='new-'+d.attr('data-package-id')+'.'+d.attr('data-duration-type')+'.'+d.attr('data-duration-cycle');q('Upgrade-success-'+h,ttrefLabel,null,null,b,'old-'+currentPlanCode),window.location.href='/dashboard'}},function(){})):l(c)}),a('#free-trial-btn').click(function(b){q('Upgrade-click-'+h,ttrefLabel,null,null,name,'old-'+currentPlanCode),b.preventDefault();var c=a(this),d={membership_package_id:c.data('package-id'),duration_type:c.data('duration-type'),duration_cycle:c.data('duration-cycle'),trial_id:c.data('trial-id'),freetrial:1,redirect:1,ref:'Pmverify_Trial_signupPVPos',back:a('#successUrl').attr('value')};typeof paymentVerified!='undefined'&&paymentVerified?window.location='/membership/onjoin.php?'+a.param(d):(a('.membership-upsell-section').toggleClass('is-verify-step'),a('#payment-methods-inner').show(),a('html,body').animate({scrollTop:a('#payment-methods-inner').offset().top-60},'slow'))}),a('#limited-trial-btn').click(function(a){a.preventDefault(),window.location='/jobs/myskills/1/?funnel=true&select_limited=true'}),a('#change-payment-method-btn').click(function(b){b.preventDefault(),a('.membership-upsell-section').toggleClass('is-verify-step'),a('#payment-methods-inner').show(),a('html,body').animate({scrollTop:a('#payment-methods-inner').offset().top-60},'slow')}),a('[data-trigger="start-trial-cta"]').click(function(b){q('Upgrade-click-'+h,ttrefLabel,null,null,name,'old-'+currentPlanCode),b.preventDefault();var c=a(this),d={membership_package_id:c.data('package-id'),duration_type:c.data('duration-type'),duration_cycle:c.data('duration-cycle'),trial_id:c.data('trial-id'),freetrial:1,redirect:1,ref:'Pmverify_Trial_signupPVPos',back:a('#successUrl').attr('value')};typeof paymentVerified!='undefined'&&paymentVerified?window.location='/membership/onjoin.php?'+a.param(d):l(b)}),a('[data-trigger="show-more-benefits"]').click(function(){document.querySelector('[data-trigger="more-benefits"]').classList.remove('is-collapsed'),document.querySelector('[data-trigger="benefit-disclaimer"]').classList.remove('is-hidden'),document.querySelector('[data-trigger="show-more-benefits"]').classList.add('is-collapsed')})})})()})